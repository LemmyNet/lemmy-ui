steps:
  fetch_git_submodules:
    image: node:20-alpine
    commands:
      - apk add git
      - git submodule init
      - git submodule update --recursive --remote
      # Install pnpm
      - wget -qO- https://get.pnpm.io/install.sh | ENV="$HOME/.shrc" SHELL="$(which sh)" sh -
      - source /root/.shrc

  install:
    image: node:20-alpine
    commands:
      - pnpm i

  lint:
    image: node:20-alpine
    commands:
      - pnpm lint

  build_dev:
    image: node:20-alpine
    commands:
      - pnpm build:dev

  publish_release_docker:
    image: woodpeckerci/plugin-docker-buildx
    secrets: [docker_username, docker_password]
    settings:
      repo: dessalines/lemmy-ui
      dockerfile: Dockerfile
      platforms: linux/amd64, linux/arm64
      tag: ${CI_COMMIT_TAG}
    when:
      event: tag

  nightly_build:
    image: woodpeckerci/plugin-docker-buildx
    secrets: [docker_username, docker_password]
    settings:
      repo: dessalines/lemmy-ui
      dockerfile: Dockerfile
      platforms: linux/amd64, linux/arm64
      tag: dev
    when:
      event: cron

  notify_on_failure:
    image: alpine:3
    commands:
      - apk add curl
      - "curl -d'Lemmy-UI CI build failed: ${CI_PIPELINE_URL}' ntfy.sh/lemmy_drone_ci"
    when:
      status: [failure]

  notify_on_tag_deploy:
    image: alpine:3
    commands:
      - apk add curl
      - "curl -d'lemmy-ui:${CI_COMMIT_TAG} deployed' ntfy.sh/lemmy_drone_ci"
    when:
      event: tag
